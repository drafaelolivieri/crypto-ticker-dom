kube-prometheus-stack:
  fullnameOverride: prometheus
  grafana:
    enabled: true
    replicas: 1
    service:
      type: ClusterIP
    persistence:
      enabled: true
      size: 10Gi
    grafana.ini:
      security:
        allow_embedding: true
      auth:
        disable_login_form: false
      auth.anonymous:
        enabled: true
        org_role: Admin
      server:
        domain: cs-us-east1-yeah.cloudshell.dev
        root_url: https://3001-cs-7bc564a6-1c3a-4afa-8e1a-86a29dba4879.cs-us-east1-yeah.cloudshell.dev
        serve_from_sub_path: true
      database:
        cache_mode: shared
        wal_enabled: true
        busy_timeout: 30000
      dataproxy:
        timeout: 300
        keep_alive_seconds: 60
        expect_continue_timeout_seconds: 10
        idle_conn_timeout_seconds: 90
        response_limit: 0
    strategy:
      type: Recreate
    additionalDataSources:
      - name: Tempo
        type: tempo
        url: http://observability-tempo:3100
        access: proxy
        jsonData:
          httpMethod: GET
          tracesToLogs:
            datasourceUid: prometheus
          serviceMap:
            datasourceUid: prometheus
          nodeGraph:
            enabled: true
          search:
            hide: false
          lokiSearch:
            datasourceUid: prometheus
          timeout: 60
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 50Gi
      serviceMonitorSelector: {}
      serviceMonitorNamespaceSelector: {}
      serviceMonitorSelectorNilUsesHelmValues: false
      podMonitorSelector: {}
      podMonitorNamespaceSelector: {}
      podMonitorSelectorNilUsesHelmValues: false
      additionalScrapeConfigs:
        - job_name: prometheus
          static_configs:
            - targets:
              - localhost:9090

        - job_name: crypto-ticker-staging
          metrics_path: /metrics
          scheme: http
          static_configs:
            - targets:
              - crypto-ticker-staging:8080
          metric_relabel_configs:
            - source_labels: [__name__]
              target_label: environment
              replacement: staging

        - job_name: crypto-ticker-prod
          metrics_path: /metrics
          scheme: http
          static_configs:
            - targets:
              - crypto-ticker-prod:8080
          metric_relabel_configs:
            - source_labels: [__name__]
              target_label: environment
              replacement: production

        - job_name: tempo
          metrics_path: /metrics
          scheme: http
          static_configs:
            - targets:
              - observability-tempo:3200
          metric_relabel_configs:
            - source_labels: [__name__]
              target_label: environment
              replacement: monitoring

tempo:
  enabled: true
  nameOverride: tempo
  fullnameOverride: tempo-observability
  serviceMonitor:
    enabled: true
  service:
    type: ClusterIP
  persistence:
    enabled: true
    size: 10Gi
  receivers:
    otlp:
      protocols:
        grpc:
          endpoint: "0.0.0.0:4317"
        http:
          endpoint: "0.0.0.0:4318"
  storage:
    trace:
      backend: local
      local:
        path: /var/tempo/traces
  config: |
    server:
      http_listen_port: 3100
      grpc_server_max_recv_msg_size: 8388608
      grpc_server_max_send_msg_size: 8388608
      http_server_read_timeout: 300s
      http_server_write_timeout: 300s
    distributor:
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: "0.0.0.0:4317"
            http:
              endpoint: "0.0.0.0:4318"
    ingester:
      trace_idle_period: 10s
      max_block_bytes: 1_000_000
      max_block_duration: 5m
    compactor:
      compaction:
        block_retention: 48h
    metrics_generator:
      registry:
        external_labels:
          source: tempo
    storage:
      trace:
        backend: local
        local:
          path: /var/tempo/traces
  extraArgs:
    "search.enabled": "true"

 